# Fixed Caddyfile for Plane on Railway
# Adds missing /live/* route for WebSocket collaboration
# Updated: 2026-01-05 - Fix Host header & HTTPS protocol forwarding

# global options
{
	admin off
	persist_config off
	auto_https off
	log {
		format json
	}
	servers {
		trusted_proxies static private_ranges 100.0.0.0/8
	}
}

:{$PORT} {
	log {
		format json
	}

	# Allow large file uploads (25 MB to accommodate 20 MB limit + overhead)
	request_body {
		max_size 25MB
	}

	reverse_proxy /* {$WEB_ENDPOINT} {
		header_up Host {http.request.host}
		header_up X-Forwarded-Host {http.request.host}
		header_up X-Forwarded-Proto https
	}

	# FIXED: Live service for WebSocket collaboration (Pages editor)
	# Explicitly forward WebSocket upgrade headers and auth cookies
	handle /live/* {
		reverse_proxy {$LIVE_ENDPOINT} {
			header_up Host {http.request.host}
			header_up X-Forwarded-Host {http.request.host}
			header_up X-Forwarded-Proto https
			header_up Connection {http.request.header.Connection}
			header_up Upgrade {http.request.header.Upgrade}
			header_up Cookie {http.request.header.Cookie}
			header_up Authorization {http.request.header.Authorization}
		}
	}

	handle /god-mode/* {
		reverse_proxy {$ADMIN_ENDPOINT} {
			header_up Host {http.request.host}
			header_up X-Forwarded-Host {http.request.host}
			header_up X-Forwarded-Proto https
		}
	}

	handle /api/* {
		reverse_proxy {$API_ENDPOINT} {
			header_up Host {http.request.host}
			header_up X-Forwarded-Host {http.request.host}
			header_up X-Forwarded-Proto https
		}
	}

	handle /auth/* {
		reverse_proxy {$API_ENDPOINT} {
			header_up Host {http.request.host}
			header_up X-Forwarded-Host {http.request.host}
			header_up X-Forwarded-Proto https
		}
	}

	handle /spaces/* {
		reverse_proxy {$SPACES_ENDPOINT} {
			header_up Host {http.request.host}
			header_up X-Forwarded-Host {http.request.host}
			header_up X-Forwarded-Proto https
		}
	}

	handle /{$BUCKET_NAME}/* {
		reverse_proxy {$BUCKET_ENDPOINT} {
			header_up Host {http.request.host}
			header_up X-Forwarded-Host {http.request.host}
			header_up X-Forwarded-Proto https
		}
	}
}
